# ExecDiff Action Trace - Manual Test Guide

## Overview
This guide provides step-by-step instructions to manually test the ExecDiff action tracing functionality, including workspace metadata snapshots, file/package change detection, and persistent logging.

---

## Test Scenario: Create Files and Track Changes

### Prerequisites
- Python 3.8+
- ExecDiff library installed or accessible

### Step 1: Create Test Directory
```bash
mkdir test_manual
cd test_manual
```

### Step 2: Create Python Test Script
Create a file named `test_trace.py`:

```python
import execdiff
import json
import os

# Start tracing the workspace
execdiff.start_action_trace(workspace=".")

# Simulate AI-generated work: create files
with open("output.txt", "w") as f:
    f.write("Generated by AI\n")

with open("data.json", "w") as f:
    json.dump({"status": "complete"}, f)

# Stop and collect diff
diff = execdiff.stop_action_trace()
print(json.dumps(diff, indent=2))
```

### Step 3: Run the Test
```bash
python3 test_trace.py
```

### Step 4: Expected Output

The script should print a JSON diff showing two files created:

```json
{
  "files": {
    "created": [
      {
        "path": "data.json",
        "mtime": 1771438775.8724225,
        "size": 22
      },
      {
        "path": "output.txt",
        "mtime": 1771438775.872263,
        "size": 16
      }
    ],
    "modified": [],
    "deleted": []
  },
  "packages": {
    "installed": [],
    "removed": [],
    "upgraded": []
  }
}
```

### Step 5: Verify Log File Creation

Check that the log file was created:

```bash
cat .execdiff/logs/actions.jsonl
```

Expected output: One JSON line containing timestamp, workspace path, and the complete diff:

```json
{
  "timestamp": "2026-02-18T18:19:35.872838",
  "workspace": "/Users/anup-admin/source_code/ExecDiff/execdiff/test_manual",
  "diff": {
    "files": {
      "created": [
        {
          "path": "data.json",
          "mtime": 1771438775.8724225,
          "size": 22
        },
        {
          "path": "output.txt",
          "mtime": 1771438775.872263,
          "size": 16
        }
      ],
      "modified": [],
      "deleted": []
    },
    "packages": {
      "installed": [],
      "removed": [],
      "upgraded": []
    }
  }
}
```

### Step 6: Test Log Appending

Run the test again to verify logs are appended (not overwritten):

```bash
python3 test_trace.py
wc -l .execdiff/logs/actions.jsonl
```

Expected: The log file should now have **2 lines** (one per run).

---

## Test Scenario 2: Modify and Delete Files

### Create Extended Test Script
Create `test_trace_extended.py`:

```python
import execdiff
import json
import os
import time

# Start first trace
execdiff.start_action_trace(workspace=".")

# Create initial files
with open("file1.txt", "w") as f:
    f.write("initial content\n")

with open("file2.txt", "w") as f:
    f.write("data\n")

diff1 = execdiff.stop_action_trace()
print("=== TRACE 1: File Creation ===")
print(json.dumps(diff1, indent=2))

# Wait a moment
time.sleep(1)

# Start second trace
execdiff.start_action_trace(workspace=".")

# Modify a file
with open("file1.txt", "w") as f:
    f.write("modified content version 2\n")

# Delete a file
os.remove("file2.txt")

# Create a new file
with open("file3.txt", "w") as f:
    f.write("new file\n")

diff2 = execdiff.stop_action_trace()
print("\n=== TRACE 2: Modifications ===")
print(json.dumps(diff2, indent=2))
```

### Run Extended Test
```bash
python3 test_trace_extended.py
```

### Expected Output

**TRACE 1** should show file creation:
```json
{
  "files": {
    "created": [
      {"path": "file1.txt", "mtime": ..., "size": 15},
      {"path": "file2.txt", "mtime": ..., "size": 5}
    ],
    "modified": [],
    "deleted": []
  },
  "packages": {...}
}
```

**TRACE 2** should show modifications:
```json
{
  "files": {
    "created": [
      {"path": "file3.txt", "mtime": ..., "size": 9}
    ],
    "modified": [
      {
        "path": "file1.txt",
        "before_mtime": ...,
        "after_mtime": ...,
        "before_size": 15,
        "after_size": 26
      }
    ],
    "deleted": [
      {"path": "file2.txt", "mtime": ..., "size": 5}
    ]
  },
  "packages": {...}
}
```

---

## Test Scenario 3: Package Installation Detection

### Create Package Test Script
Create `test_packages.py`:

```python
import execdiff
import subprocess
import json

# Start trace
execdiff.start_action_trace(workspace=".")

# Install a package
subprocess.run(["python3", "-m", "pip", "install", "requests"], capture_output=True)

# Stop trace
diff = execdiff.stop_action_trace()

print(json.dumps(diff, indent=2))

# View log file
import os
log_file = os.path.join(".", ".execdiff", "logs", "actions.jsonl")
if os.path.exists(log_file):
    print("\n=== LOG ENTRY ===")
    with open(log_file, "r") as f:
        for line in f:
            entry = json.loads(line)
            print(json.dumps(entry, indent=2))
```

### Run Package Test
```bash
python3 test_packages.py
```

### Expected Behavior
- If `requests` is already installed: `installed` list will be empty
- If `requests` is not installed: `installed` list will show the new package
- Log file will be updated with the complete action trace

---

## Cleanup

After testing, remove test files:

```bash
cd ..
rm -rf test_manual
```

---

## Key Assertions

✅ **Files are tracked**: created, modified (mtime/size change), deleted  
✅ **Workspace logging**: `.execdiff/logs/actions.jsonl` is created  
✅ **Timestamp included**: Each log entry has ISO8601 timestamp  
✅ **Logs are appended**: Running multiple traces creates multiple lines  
✅ **Metadata captured**: File size, mtime, and package versions are recorded  
✅ **No data loss**: Logs are never overwritten, always appended  

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| `ModuleNotFoundError: No module named 'execdiff'` | Ensure you're running from the execdiff project directory or install with `pip install -e .` |
| Log file not created | Check directory permissions; ensure workspace path is writable |
| Packages not detected | Run package installation in a separate subprocess (not in same Python process) |
| Log file permissions | Ensure `.execdiff/logs/` directory is writable by your user |

---

## Integration Notes

Use ExecDiff in your AI execution pipeline:

```python
import execdiff

# Start tracing before AI code generation/execution
execdiff.start_action_trace(workspace="./generated_code")

# Run generated AI code
exec(ai_generated_code)

# Capture what changed
changes = execdiff.stop_action_trace()

# Use changes to understand side effects
print(f"Files created: {len(changes['files']['created'])}")
print(f"Packages installed: {len(changes['packages']['installed'])}")
```

All action traces are automatically logged to `.execdiff/logs/actions.jsonl` for audit and replay purposes.
